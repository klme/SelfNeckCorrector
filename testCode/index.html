<!DOCTYPE html>
<html>
    <head>
    <title>clmtracker</title>
    <style>
    video#video, canvas#canvas{
    	width: 640px;  /* 横幅 */
    	height: 480px; /* 縦幅 */
    	border: 1px solid black;
    	overflow:hidden;
    }

    </style>
    <script src="js/clmtrackr.js"></script>
    <script src="models/model_pca_10_svm.js"></script>
    <script>
    var tracker = null;
    window.addEventListener("load",initMedia);

    function initMedia(){
      //video要素の取得
      var video = document.getElementById("video");
    	//canvas要素の取得
    	var canvas = document.getElementById("canvas");
      tracker = new clm.tracker({useWebGL : true});
      tracker.init(pModel);
      console.log(pModel);

      var videoW = video.clientWidth;
      var videoH = video.clientHeight;

      // windowの横幅と動画の横幅の比率を算出

      video.width = videoW;
      video.height = videoH;



      canvas.context = canvas.getContext("2d");
    	canvas.width = canvas.clientWidth;
    	canvas.height = canvas.clientHeight;

      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    	if (navigator.getUserMedia){
    		//ユーザーメディアの設定
    		navigator.getUserMedia( { video : true },
    			function ( stream ){
    				//video要素のsrc属性に映像データのURLを与える
    				video.src = window.URL.createObjectURL( stream );
            tracker.start(video);
            loop();

            document.addEventListener("clmtrackrConverged",clmtrackrConvergedHandler);
            document.addEventListener("clmtrackrLost",clmtrakrLostHandler);

    			},function ( error ){
    				//失敗時にエラーをコンソールへ出力
    				console.log( error );
    			});
    	}
    }


function clmtrackrConvergedHandler(){
  document.removeEventListener("clmtrackrConverged",clmtrackrConvergedHandler);
  document.removeEventListener("clmtrackrLost",clmtrakrLostHandler);


}

function clmtrakrLostHandler(){
  document.removeEventListener("clmtrackrConverged",clmtrackrConvergedHandler);
  document.removeEventListener("clmtrackrLost",clmtrakrLostHandler);
}

//function





function loop() {
	//映像データの準備状況の確認
	if (video.readyState === video.HAVE_ENOUGH_DATA ){
		//現時点で描画されているvideo要素の画像をcanvas要素に出力
		canvas.context.drawImage(video, 0, 0, canvas.width, canvas.height);
    var positions = tracker.getCurrentPosition();
    if(positions){
      tracker.draw(canvas); // 判定結果をcanvasに描画します。
      console.log(positions);
    }
	}
	//ループ関数の再帰呼び出し
	requestAnimationFrame( loop );
}

    </script>
    </head>
    <body>
    <video autoplay id="video"></video>
    <canvas id="canvas"></canvas>
    </body>
</html>
